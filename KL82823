local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local placeId = game.PlaceId

local excludedNames = {
    ["U3RT_SOVIETxKILLA"] = false,
    ["U3RT_KILLAxSOVIET"] = false,
}

local function find18PlayerServer()
    local cursor = nil
    for _ = 1, 5 do -- Limita tentativas
        local url = "https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?sortOrder=Desc&limit=100"
        if cursor then
            url = url .. "&cursor=" .. cursor
        end

        local success, response = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(url))
        end)

        if success and response and response.data then
            for _, server in ipairs(response.data) do
                if server.playing == 18 and server.maxPlayers == 20 and server.id ~= game.JobId then
                    return server.id
                end
            end
            cursor = response.nextPageCursor
        else
            break
        end
        task.wait(1)
    end
    return nil
end

local function hopToServer()
    local serverId = find18PlayerServer()
    if serverId then
        TeleportService:TeleportToPlaceInstance(placeId, serverId, LocalPlayer)
    else
        warn("Nenhum servidor adequado encontrado. Tentando novamente em 15s...")
        task.delay(15, hopToServer)
    end
end

task.delay(48, hopToServer)

local function setupDiedListener(character)
    local hum = character:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.Died:Connect(hopToServer)
    end
end

if LocalPlayer.Character then
    setupDiedListener(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(setupDiedListener)

RunService.Heartbeat:Connect(function()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and excludedNames[player.DisplayName] == false then
            hopToServer()
            break
        end
    end
end)

RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.Health = hum.MaxHealth
    end
end)

task.spawn(function()
    local Lighting = game:GetService("Lighting")
    local Terrain = workspace:FindFirstChildOfClass("Terrain")

    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e9
    Lighting.Brightness = 0
    Lighting.EnvironmentDiffuseScale = 0
    Lighting.EnvironmentSpecularScale = 0
    Lighting.ClockTime = 14

    for _, v in pairs(Lighting:GetDescendants()) do
        if v:IsA("PostEffect") then
            v.Enabled = false
        end
    end

    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 1
    end

    local function cleanVisuals(obj)
        for _, c in ipairs(obj:GetDescendants()) do
            if c:IsA("Decal") or c:IsA("ParticleEmitter") or c:IsA("Fire") or c:IsA("Smoke") or c:IsA("Sparkles") then
                pcall(function() c:Destroy() end)
            elseif c:IsA("BasePart") then
                pcall(function()
                    c.Material = Enum.Material.SmoothPlastic
                    c.Reflectance = 0
                    c.CastShadow = false
                end)
            end
        end
    end

    cleanVisuals(workspace)
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            cleanVisuals(player.Character)
        end
    end
end)

task.spawn(function()
    local Backpack = LocalPlayer:WaitForChild("Backpack")
    local tool = Backpack:WaitForChild("Punch")
    repeat task.wait() until LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
    local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    humanoid:EquipTool(tool)
    while true do
        task.wait(0.3)
        if tool and tool.Parent == LocalPlayer.Character then
            tool:Activate()
        end
    end
end)

task.spawn(function()
    _G.lockPosition = true
    local HRP
    LocalPlayer.CharacterAdded:Connect(function(char)
        HRP = char:WaitForChild("HumanoidRootPart")
    end)
    RunService.Heartbeat:Connect(function()
        if _G.lockPosition and HRP then
            HRP.Velocity = Vector3.new(0, 0, 0)
            HRP.RotVelocity = Vector3.new(0, 0, 0)
        end
    end)
end)
